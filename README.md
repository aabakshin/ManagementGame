# Игра "Менеджмент"
Данная игра была предложена фирмой Avalon Hill Company для обучения основам управления предприятием. Ч.Уэзерелл отметил чрезвычайную привлекательность этой игры в качестве упражнения для
программистов. В этом репозитории находится моя реализация этой игры на чистом Си. Некоторые части программы также реализованы на C++ без использования каких-либо сторонних библиотек, контейнеров STL и т.д.
## Состав проекта
Проект сделан по клиент-серверной архитектуре. Клиентом может быть как реальный игрок, так и компьютер, стратегия поведения которого задаётся скриптовыми текстовыми файлами на специально созданном для него языке.
Все скрипты должны находиться в директории `game_scripts`. Краткое описание скриптового языка будет представлено далее.
### /
- `binaries`: Содержит исполняемые модули и их исходные коды, а также Makefile'ы для сборки проекта
- `game_scripts`: Содержит скрипты для интерпретации игроком-компьютером
- `includes`: Содержит заголовочные файлы модулей для всего проекта
- `libs`: Содержит исходные коды и объектные файлы модулей для всего проекта 
- `tests`: Содержит файлы и исходные тексты для тестирования некоторых частей проекта(например, контейнеров)
### /binaries
- `bot_mg`: Содержит исходник, бинарник и Makefile для сборки клиента-компьютера
- `client`: Содержит исходник, бинарник и Makefile для сборки клиента-игрока
- `server`: Содержит исходник, бинарник и Makefile для сборки сервера
## Запуск проекта
Проект собирался под Linux Mint 20.3, версия ядра Linux: 5.4.0-148-generic, архитектура: x86-64
Для запуска проекта необходимо:
- Установить SSH-сервер:
	```
	$ sudo apt update
	$ sudo apt upgrade
	```

	```
	$ sudo apt install openssh-server
	```

	```
	$ systemctl status ssh
	```
	Если всё настроено правильно, то должна быть надпись о том, что сервер работает

- Настроить ssh-туннель с github-сервером:
	1. Создание нового ключа SSH и привязка к ssh-agent:
	```
	https://docs.github.com/ru/authentication/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent
	```
	2. Добавление нового ключа SSH в учётную запись GitHub:
	```
	https://docs.github.com/ru/authentication/connecting-to-github-with-ssh/adding-a-new-ssh-key-to-your-github-account
	```
	3. Проверка работы SSH-соединения:
	```
	$ ssh -T git@github.com
	```

- Клонировать репозиторий:
	```
	git clone git@github.com:aabakshin/ManagementGame.git
	```

- Собрать бинарник сервера: Перейти в директорию `/binaries/server/`. Ввести команду `make server`
- Собрать бинарник клиента-игрока: Перейти в директорию `/binaries/client/`. Ввести команду `make client`
- Собрать бинарник клиента-компьютера(если нужно подключить ботов к игре): Перейти в директорию `/binaries/bot_mg/`. Ввести команду `make bot_mg`
- Далее запускается один экземпляр сервера: `./server 7777`, порт указывается любой свободный
- Далее запускаются несколько экземпляров игроков: `./client 192.168.50.128 7777`, в параметрах указывается адрес сервера и порт
- Также можно добавлять ботов, для этого перед стартом игры(в лобби), создаются экземпляры ботов: `./bot_mg 192.168.50.128 7777 ../game_scripts/example.txt`, последний параметр - путь до файла со скриптом для бота.
- При необходимости пересборки проекта можно для каждого из модулей `server`, `client`, `bot_mg` в их директориях предварительно выполнить команду: `make clean`
## Описание скриптового языка
### Общее описание
Программа на этом языке состоит из операторов, каждый из которых может быть помечен меткой. Для упрощения анализа имя метки начинается всегда с символа `@` и заканчивается `:`; имя метки может состоять из латинских букв, цифр и знаков подчёркивания. Если оператор начинается не с метки, считается, что этот оператор не имеет метки. Конец оператора обозначается `;`.
В языке присутствуют следующие операторы:
- оператор присваивания
- оператор безусловного перехода(`goto`)
- условный оператор(`if`)
- операторы игровых действий(`buy`, `sell`, `prod`, `build`, `endturn`)
- оператор отладочной печати(`print`)
### Арифметика и выражения
В языке поддерживаются арифметические операции:
- сложение(+), вычитание(-)
- умножение(\*), деление(/), взятие остатка от деления(%)
- операции сравнения(<, >, =)
- логические операции(&, |, !)
- унарный минус

Операции сравнения выдают значение 1 для истины, 0 для лжи

Наибольший приоритет имеют умножение, деление и остаток, далее сложение и вычитание, операции сравнения имеют низший приоритет

В качестве операндов могут выступать `константы`, `переменные`, `обращения к встроенным функциям`

В выражениях могут присутствовать круглые скобки любой вложенности.
### Переменные и присваивания
Переменные в языке имеют имена, начинающиеся с знака `$`. В имени переменной могут
присутствовать латинские буквы, цифры, знак подчёркивания. Переменные заносятся в спец.
таблицу в момент первого присваивания.

Оператор присваивания имеет следующий синтаксис:

`<присваивание> ::= <переменная> = <выражение> ';'`

`<переменная> ::= <имя_переменной>`

По обе стороны от знака присваивания допустимо любое кол-во пробельных символов.
### Условный оператор
Условный оператор имеет следующий синтаксис:

`<условный оператор> ::= 'if' <выражение> 'then' <оператор> ';'`
### Встроенные функции для получения игровой информации
Все имена функций начинаются со знака `?`. Если функция имеет аргументы, то вслед за именем функции должно идти заключённое в круглые скобки перечисление параметров функции через запятую. На данный момент есть следующие функции:
- `?my_id(без параметров)` - выдаёт номер игрока, присвоенный сервером нашему боту
- `?turn(без параметров)` - выдаёт текущий номер хода
- `?players(без параметров)` - выдаёт общее кол-во игроков
- `?active_players(без параметров)` - выдаёт кол-во игроков, продолжающих игру(не обанкротившихся и не вышедших из игры к настоящему моменту)
- `?supply(без параметров)` - выдаёт кол-во сырья, выставленное банком на продажу на текущий ход
- `?raw_price(без параметров)` - выдаёт минимальную стоимость сырья, определённую банком на текущий ход
- `?demand(без параметров)` - выдаёт кол-во продукции, которую банк намерен купить на текущем ходу
- `?production_price(без параметров)` - выдаёт максимальную цену продукции, определённую банком на текущий ход
- `?money(один параметр, номер игрока)` - выдаёт кол-во денег у заданного игрока
- `?raw(один параметр, номер игрока)` - выдаёт кол-во сырья у заданного игрока
- `?production(один параметр, номер игрока)` - выдаёт кол-во готовой продукции у заданного игрока
- `?factories(один параметр, номер игрока)` - выдаёт общее кол-во фабрик у заданного игрока
- `?manufactured(один параметр, номер игрока)` - сколько единиц продукции произведено игроком на **предыдущем** ходу
- `?result_raw_sold(один параметр, номер игрока)` - если данный игрок покупал сырьё на предыдущем ходу, выдаёт кол-во купленного сырья, в противном случае - ноль
- `?result_raw_price(один параметр, номер игрока)` - если данный игрок покупал сырьё на предыдущем ходу, выдаёт цену, по которой совершена покупка, в противном случае - ноль
- `?result_prod_bought(один параметр, номер игрока)` - сколько единиц продукции банк купил у данного игрока на предыдущем ходу
- `?result_prod_price(один параметр, номер игрока)` - если данный игрок продавал продукцию на предыдущем ходу, выдаёт цену, по которой совершена продажа, в противном случае - ноль
### Встроенные операторы для совершения игровых действий
Операторы для совершения игровых действий имеют следующий синтаксис:

`<игровой оператор> ::= <имя0> ';'`

`                       <имя1> <операнд> ';'`

`                       <имя2> <операнд1> ',' <операнд2> ';'`

`<имя0>             ::= 'endturn'`

`<имя1>             ::= 'prod' | 'build'`

`<имя2>             ::= 'buy' | 'sell'`

Текущий набор операторов следующий:
- `buy <количество>, <цена>` - выставить заявку на покупку заданного количества сырья по заданной цене
- `sell <количество>, <цена>` - выставить заявку на продажу заданного количества продукции по заданной цене
- `prod <количество>` - запустить в производство заданное кол-во продукции
- `build <количество>` - начать строительство заданного кол-ва фабрик
- `endturn` - сообщить серверу о завершении хода и дождаться сообщения от сервера о том, что начался новый ход

Во всех случаях операнды представляют собой произвольные допустимые арифметические выражения, правовычисляемое выражение(rvalue) или игровую функцию

Для проверки правильности синтаксиса используется символ `;`, обозначающий конец оператора

### Оператор отладочной печати
Оператор отладочной печати имеет следующий синтаксис:

`<оператор_печати>` ::= `'print' <п_список> ';'` 

`<п_список>`		::= `<п_элемент> | <п_элемент> ',' <п_список>`

`<п_элемент>`		::= `<выражение> | <строка>`

Оператор отладочной печати обрабатывает свои параметры слева направо. Встреченные строки
символов выдаются на стандартный вывод; встреченные выражения вычисляются и выдаются их
результаты. Конец списка параметров определяется по встреченному символу `;`.

## Краткое описание порядка игры
В каждом "месяце" игроки производят на своих фабриках продукцию из сырья. `Одна фабрика` может произвести `одну единицу продукции`, израсходовав при этом `одну единицу сырья` и `2000 Р`.

В случае, если у игрока недостаточно сырья или денег, чтобы обеспечить работу всех фабрик,либо в связи с неблагоприятной обстановкой на рынке у игрока скопилось слишком много готовой продукции, фабрика может ничего не производить (`что не исключает ежемесячных издержек`).

Каждый "месяц" банк проводит аукционы по продаже сырья и скупке продукции. Аукционы проводятся в соответствии с `"обстановкой на рынке"`. Заявки на аукционы подаются игроками `"в тёмную"`, т.е игроки ничего не знают о заявках, подаваемых другими игроками. Однако, по окончании аукциона банк сообщает всем игрокам полную информацию о результатах торгов (а именно, кому, сколько, и по какой цене продано сырья, а также у кого, сколько и по какой цене куплено продукции).

В каждом "месяце" игрок может сделать заявку на строительство новых фабрик. Фабрика стоит `5000 Р` и начинает давать продукцию на `5й "месяц"` после начала строительства. Половина стоимости строительства списывается с игрока при подаче заявки, вторая половина за месяц до окончания строительства.

Закончив подачу заявок на данный месяц, игрок заявляет об окончании хода. Когда все игроки заявили об окончании хода, игровой месяц завершается.

По итогам месяца с каждого игрока списываются ежемесячные издержки, а именно:
- `300 Р` - за оставшуюся на складе единицу сырья
- `500 Р` - за оставшуюся на складе единицу продукции
- `1000 Р` - за фабрику (независимо от того, производила она в этом месяце продукцию или нет).

Игрок, которому не хватило денег на покрытие издержек, объявляется банкротом и выбывает из игры.

Каждый игрок в любой момент может узнать о количестве денег, фабрик, единиц сырья и продукции у остальных игроков.

